# SonarCloud Notes:
# - This workflow targets SonarCloud (hosted) and uses the SonarScanner for .NET (recommended for C#).
# - It requires a repository secret:
#     SONAR_TOKEN -> a SonarCloud token (My Account > Security)
# - Project and organization are set via /k (projectKey) and /o (organization).
# - The job fails if unit tests fail or if the SonarCloud Quality Gate fails.
# - Coverage is collected with Coverlet (OpenCover format) and reported to SonarCloud.

name: SonarCloud analysis (.NET)

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read # allows SonarCloud to decorate PRs with analysis results

jobs:
  sonarcloud-dotnet:
    name: Build, test, and analyze
    runs-on: ubuntu-latest

    # Avoid running with secrets on forks' PRs
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history for better analysis (blame, new code)

      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install SonarScanner for .NET
        run: dotnet tool install --global dotnet-sonarscanner

      - name: SonarCloud - Begin analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          export PATH="$PATH:/home/runner/.dotnet/tools"
          dotnet sonarscanner begin \
            /k:"rrusson_DarkClippy" \
            /o:"rrusson" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" \
            /d:sonar.cs.opencover.reportsPaths="**/TestResults/**/coverage.opencover.xml"

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore -c Release

      - name: Test with coverage (OpenCover)
        run: |
          dotnet test --no-build -c Release \
            /p:CollectCoverage=true \
            /p:CoverletOutputFormat=opencover \
            /p:CoverletOutput=./TestResults/coverage/

      - name: SonarCloud - End analysis
      # Generate a token on Sonarcloud.io, add it to the secrets of this repo with the name SONAR_TOKEN (Settings > Secrets > Actions > add new repository secret)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end /d:sonar.token="${SONAR_TOKEN}"

      # Fail the job if the Quality Gate fails (supports SonarCloud via SONAR_HOST_URL)
      - name: SonarCloud Quality Gate
        # Pinned to commit SHA for security (v1.2.0)
        uses: SonarSource/sonarqube-quality-gate-action@cf038b0e0cdecfa9e56c198bbb7d21d751d62c3b
        timeout-minutes: 10
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
